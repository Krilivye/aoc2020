<input.txt awk -F': ' '/:/{r[$1]=$2} function expand(rule, alts, ex, i, subs, j, altex){if(index(rule,"\"")) return substr(rule,2,1);  split(rule,alts," \\| "); ex=""; for(i in alts) { split(alts[i],subs," "); altex=""; for(j=1;j<=length(subs);j++) { altex=altex expand(r[subs[j]])} if(ex!="") ex=ex"|"; ex=ex altex } return "("ex")"} /^$/ {re="^"expand(r[0])"$"} /^[ab]/ {t+=match($0, re)} END {print t}'
